<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Frontend Vue</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
        <script src="https://unpkg.com/vue"></script>
        <script src="https://unpkg.com/vuex"></script>
    </head>
    <body>
        <div id="app">
        <h1>[[ heading ]]</h1>
        <p>[[paragraph]]</p><br>
        <button @click="this.getUser">Get User</button>
        <button @click="this.logout">Log out</button>
        <h2>authUser projects:</h2>
        <div v-if="!loading"> <p v-for="item in user.user_projects" v-bind:key="item.id"><b>[[ item.project ]]:</b> [[ item.project_name ]]</p></div>



        <h4>Default Project: [[ project ]]</h4>
        <p>CSRF: <span style="color:blueviolet">[[ csrf ]]</span></p></div>
    <script>
        const store = new Vuex.Store({
            state: {
                // USER
                authUser: null,
                // isAuthenticated: true,
                // PROJECT
                project: null,

                site: {
                    id: 1071,
                    sitename: 'Red Willow Pond'
                },
                observation: {
                    obsType: {
                        id: null,
                        name: ''
                    },
                    kv: {},
                    inOutbox: false,
                    entered: false
                },
                outbox: [1, 3, 5],
                inbox: [1, 2]
            },
            getters: {
                authUser: state => {
                    return state.authUser
                },
                project: state => {
                    return state.project
                },
                site: state => {
                    return state.site
                },
                observation: state => {
                    return state.observation
                }
            },
            mutations: {
                SET_AUTH_USER(state, authUser) {
                    Vue.set(state, 'authUser', authUser)
                    // Vue.set(state, 'isAuthenticated', isAuthenticated)
                },
                SET_PROJECT(state, project) {
                    Vue.set(state, 'project', project)
                },
                SET_SITE(state, site) {
                    Vue.set(state, 'site', site)
                },
                SET_OBSERVATION(state, observation) {
                    Vue.set(state, 'observation', observation)
                },
                LOGOUT(state, authUser) {
                    Vue.set(state, 'authUser', null)
                    Vue.set(state, 'project', null)
                }
            },
            actions: {
                setAuthUser({ commit }, user) {
                    commit('SET_AUTH_USER', user)
                    commit('SET_PROJECT', user.default_project)
                },
                setProject({ commit }, project) {
                    commit('SET_PROJECT', project)
                },
                setSite({ commit }, site) {
                    commit('SET_SITE', site)
                },
                setObservation({ commit }, obj) {
                    commit('SET_OBSERVATION ', obj)
                },
                logout({commit})
                {
                    return new Promise(resolve => {
                        commit('LOGOUT')
                        // MAY NEED THIS
                        // delete axios.defaults.headers.common['Authorization']
                        resolve()
                    })
                }
            }
        })

        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data() {
                return {
                    loading: true,
                    heading: 'Vue/Django experiments',
                    paragraph: 'No hot reloading, and use [[]] template interpolator'
                }
            },
            computed: {
                user() {
                    return store.getters.authUser
                },
            
                csrf() {
                    return Cookies.get('csrftoken')
                },
                project() {
                    return store.getters.project
                }
            },
            methods: {
                getUser() {
                    fetch('/api/auth-user')
                        .then(function (response) {                      // first then()
                            if (response.ok) {
                                return response.json();
                            }
                            throw new Error('Something went wrong.');
                        })
                        .then(function (data) {   
                            store.dispatch('setAuthUser', data)                       // second 
                        })
                        .catch(function (error) {                        // catch
                            console.log('Request failed', error);
                        })
                        .finally(this.loading = false);
                },
                logout() {
                    store.dispatch('logout')
                }

            }
        })
    </script>
    </body>
</html>